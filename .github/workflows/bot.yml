name: ğŸ¤– Mastodon Simple Bot

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Mastodon.py requests python-dotenv
    
    - name: ğŸ”§ Setup files
      run: |
        # Create required files if they don't exist
        if [ ! -f "counter.txt" ]; then
          echo "0" > counter.txt
          echo "âœ… Created counter.txt"
        fi
        
        if [ ! -f "used_sentences.json" ]; then
          echo '{"used_sentences": []}' > used_sentences.json
          echo "âœ… Created used_sentences.json"
        fi
        
        if [ ! -f "posted_toots.json" ]; then
          echo "" > posted_toots.json
          echo "âœ… Created posted_toots.json"
        fi
        
        # List all files
        echo ""
        echo "ğŸ“ Files in directory:"
        ls -la
        echo ""
        echo "ğŸ“„ Sample of used_sentences.json:"
        cat used_sentences.json | head -5
        echo ""
        echo "ğŸ”¢ Counter value:"
        cat counter.txt
    
    - name: ğŸ¤– Debug - Check environment
      run: |
        echo "ğŸ” Checking environment..."
        echo "Python version: $(python --version)"
        echo "Working directory: $(pwd)"
        echo ""
        echo "ğŸ“„ Checking bot.py..."
        if [ -f "bot.py" ]; then
          echo "âœ… bot.py exists"
          echo "First 10 lines:"
          head -10 bot.py
        else
          echo "âŒ bot.py NOT FOUND"
          ls -la *.py
        fi
    
    - name: ğŸ¤– Run bot
      env:
        MASTODON_ACCESS_TOKEN: ${{ secrets.MASTODON_ACCESS_TOKEN }}
        MASTODON_BASE_URL: ${{ secrets.MASTODON_BASE_URL }}
      run: |
        echo "ğŸš€ Running bot.py..."
        python bot.py 2>&1 || echo "Bot script exited with error"
    
    - name: ğŸ“Š Show statistics
      if: always()
      run: |
        echo ""
        echo "ğŸ“ˆ BOT STATISTICS:"
        echo "========================"
        
        # Simple counter check
        if [ -f "counter.txt" ]; then
          COUNTER=$(cat counter.txt 2>/dev/null || echo "ERROR")
          echo "ğŸ“Š Counter: $COUNTER"
        else
          echo "ğŸ“Š Counter: File not found"
        fi
        
        # Simple JSON check without complex parsing
        if [ -f "used_sentences.json" ]; then
          echo "ğŸ“ used_sentences.json exists"
          FILE_SIZE=$(stat -c%s "used_sentences.json" 2>/dev/null || echo "?")
          echo "   File size: ${FILE_SIZE} bytes"
        else
          echo "ğŸ“ used_sentences.json: NOT FOUND"
        fi
        
        if [ -f "posted_toots.json" ]; then
          echo "ğŸš€ posted_toots.json exists"
          LINE_COUNT=$(wc -l < posted_toots.json 2>/dev/null || echo "0")
          echo "   Lines: $LINE_COUNT"
        else
          echo "ğŸš€ posted_toots.json: NOT FOUND"
        fi
        
        echo ""
        echo "ğŸ” Final file list:"
        ls -la *.json *.txt *.py 2>/dev/null || echo "No matching files"
