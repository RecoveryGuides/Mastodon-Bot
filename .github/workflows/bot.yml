name: ğŸ¤– Mastodon Simple Bot

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install Mastodon.py==1.8.1
        pip install requests
    
    - name: ğŸ¤– Run bot
      env:
        MASTODON_ACCESS_TOKEN: ${{ secrets.MASTODON_ACCESS_TOKEN }}
        MASTODON_BASE_URL: ${{ secrets.MASTODON_BASE_URL }}
      run: python bot.py
    
    - name: ğŸ“Š Show statistics
      if: always()
      run: |
        echo "ğŸ“ˆ BOT STATISTICS:"
        echo "========================"
        
        # Initialize counter if not exists
        if [ ! -f "counter.txt" ]; then
          echo "0" > counter.txt
        fi
        
        COUNTER=$(cat counter.txt)
        echo "ğŸ“Š Response counter: $COUNTER"
        
        if [ -f "used_sentences.json" ]; then
          USED=$(python3 -c "
import json
try:
    with open('used_sentences.json', 'r') as f:
        data = json.load(f)
    used_count = len(data.get('used_sentences', []))
    print(f'ğŸ“ Used sentences: {used_count}')
except Exception as e:
    print(f'ğŸ“ Used sentences: 0 (Error: {str(e)[:50]})')
")
          echo "$USED"
        else
          echo "ğŸ“ Used sentences: 0 (File not found)"
        fi
        
        if [ -f "posted_toots.json" ]; then
          COUNT=$(wc -l < posted_toots.json 2>/dev/null | tr -d ' ' || echo "0")
          echo "ğŸš€ Published responses: $COUNT"
          
          if [ "$COUNT" -gt "0" ]; then
            echo "ğŸ“… Last responses:"
            tail -3 posted_toots.json 2>/dev/null | while read line; do
              python3 -c "
import json, sys
try:
    if sys.argv[1].strip():
        data = json.loads(sys.argv[1])
        user = data.get('user', 'unknown')
        date = data.get('date', '')[:16]
        print(f'   â€¢ {date} â†’ @{user}')
except Exception:
    pass
" "$line" 2>/dev/null || true
            done
          fi
        else
          echo "ğŸš€ Published responses: 0"
          echo "ğŸ“… Last responses: None yet"
        fi
        
        echo ""
        echo "ğŸ”§ Workflow status: âœ… COMPLETED"
        echo "â° Next run: Every 30 minutes"
