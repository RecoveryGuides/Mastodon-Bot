name: ğŸ¤– Mastodon Simple Bot

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # DODANE: token do commitÃ³w
        fetch-depth: 0
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install Mastodon.py
    
    - name: ğŸ”§ Setup files
      run: |
        # SprawdÅº czy pliki istniejÄ…, jeÅ›li nie to utwÃ³rz
        if [ ! -f "counter.txt" ]; then
          echo "0" > counter.txt
          echo "âœ… Created counter.txt"
        fi
        
        if [ ! -f "used_sentences.json" ]; then
          echo '{"used": [], "reset_date": "2024-01-01"}' > used_sentences.json
          echo "âœ… Created used_sentences.json"
        fi
        
        if [ ! -f "posted_toots.json" ]; then
          echo "" > posted_toots.json
          echo "âœ… Created posted_toots.json"
        fi
        
        # SprawdÅº czy sentences.txt istnieje
        if [ ! -f "sentences.txt" ]; then
          echo "âŒ ERROR: sentences.txt not found!"
          echo "Creating example file..."
          echo "Every small step counts when you're rebuilding your life." > sentences.txt
          echo "You're stronger than your debts." >> sentences.txt
          echo "Financial struggles are temporary." >> sentences.txt
        else
          echo "âœ… sentences.txt exists"
          echo "ğŸ“„ Sentences count: $(wc -l < sentences.txt)"
        fi
        
        echo ""
        echo "ğŸ“ Initial files:"
        ls -la *.txt *.json
    
    - name: ğŸ¤– Run bot
      env:
        MASTODON_ACCESS_TOKEN: ${{ secrets.MASTODON_ACCESS_TOKEN }}
        MASTODON_BASE_URL: ${{ secrets.MASTODON_BASE_URL }}
      run: |
        echo "ğŸš€ Starting bot..."
        python bot.py
        echo "âœ… Bot execution finished"
    
    - name: ğŸ’¾ Commit and push changes
      run: |
        # Konfiguracja git
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        echo "ğŸ“¦ Checking for file changes..."
        
        # SprawdÅº czy pliki siÄ™ zmieniÅ‚y
        if git diff --name-only | grep -q -E "counter\.txt|used_sentences\.json|posted_toots\.json"; then
          echo "ğŸ“ Changes detected in bot files!"
          
          # Dodaj zmienione pliki
          git add counter.txt used_sentences.json posted_toots.json
          
          # Commit
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M')
          git commit -m "ğŸ¤– Bot update: $TIMESTAMP"
          
          # Push
          git push
          echo "âœ… Changes committed and pushed to repository"
          
          # PokaÅ¼ co siÄ™ zmieniÅ‚o
          echo ""
          echo "ğŸ“Š Updated files:"
          if [ -f "counter.txt" ]; then
            echo "  counter.txt: $(cat counter.txt)"
          fi
          
          if [ -f "used_sentences.json" ]; then
            USED_COUNT=$(python3 -c "import json; data=json.load(open('used_sentences.json')); print(len(data.get('used', [])))" 2>/dev/null || echo "?")
            echo "  used_sentences.json: $USED_COUNT sentences used"
          fi
          
        else
          echo "ğŸ“­ No changes to commit"
        fi
    
    - name: ğŸ“Š Show statistics
      if: always()
      run: |
        echo ""
        echo "ğŸ“ˆ BOT STATISTICS:"
        echo "========================"
        
        # SprawdÅº czy bot utworzyÅ‚/wykonaÅ‚ pliki
        if [ -f "counter.txt" ]; then
          COUNTER=$(cat counter.txt 2>/dev/null || echo "error")
          echo "ğŸ“Š Counter: $COUNTER"
          NEXT_LINK=$((5 - (COUNTER % 5)))
          echo "ğŸ”— Next shop link in: $NEXT_LINK responses"
        else
          echo "ğŸ“Š Counter: NOT FOUND"
        fi
        
        if [ -f "used_sentences.json" ]; then
          python3 -c "
import json, datetime
try:
    with open('used_sentences.json', 'r') as f:
        data = json.load(f)
    
    used_count = len(data.get('used', []))
    reset_date = data.get('reset_date', 'unknown')
    today = datetime.date.today().isoformat()
    
    print(f'ğŸ“ Used sentences: {used_count}')
    print(f'ğŸ“… Reset date: {reset_date}')
    print(f'ğŸ“… Today: {today}')
    
    if reset_date != today:
        print('âš ï¸  WARNING: Will reset tomorrow!')
    
except Exception as e:
    print(f'âŒ Error reading used_sentences.json: {e}')
"
        fi
        
        if [ -f "posted_toots.json" ]; then
          LINE_COUNT=$(wc -l < posted_toots.json 2>/dev/null || echo "0")
          echo "ğŸš€ Total responses posted: $LINE_COUNT"
          
          if [ "$LINE_COUNT" -gt "0" ]; then
            echo "ğŸ“… Last 3 responses:"
            tail -3 posted_toots.json 2>/dev/null | while read line; do
              python3 -c "
import json, sys, datetime
try:
    if sys.argv[1].strip():
        data = json.loads(sys.argv[1])
        date_str = data.get('date', '')
        to_user = data.get('to', 'unknown')
        
        # Formatuj datÄ™
        if 'T' in date_str:
            dt = datetime.datetime.fromisoformat(date_str.replace('Z', '+00:00'))
            time_str = dt.strftime('%H:%M')
        else:
            time_str = date_str[:5] if len(date_str) >= 5 else date_str
        
        print(f'   â€¢ {time_str} â†’ @{to_user}')
except Exception as e:
    pass
" "$line" 2>/dev/null || true
            done
          fi
        fi
        
        if [ -f "sentences.txt" ]; then
          TOTAL_SENTENCES=$(wc -l < sentences.txt 2>/dev/null || echo "0")
          echo "ğŸ“š Total sentences available: $TOTAL_SENTENCES"
        fi
        
        echo ""
        echo "â° Next run: ~30 minutes"
        echo "ğŸ”„ Workflow completed at: $(date '+%H:%M:%S')"
